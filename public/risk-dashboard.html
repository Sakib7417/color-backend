<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Risk Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 20px;
            border-bottom: 3px solid #3b82f6;
        }

        .header h1 {
            font-size: 28px;
            color: #60a5fa;
            margin-bottom: 10px;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .connection-status.connected {
            background: #166534;
            color: #86efac;
        }

        .connection-status.disconnected {
            background: #991b1b;
            color: #fca5a5;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .container {
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #334155;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            font-size: 18px;
            color: #94a3b8;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #f8fafc;
        }

        .stat-label {
            font-size: 14px;
            color: #64748b;
            margin-top: 5px;
        }

        .risk-indicator {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .risk-safe {
            background: #166534;
            color: #86efac;
        }

        .risk-medium {
            background: #854d0e;
            color: #fde047;
        }

        .risk-high {
            background: #991b1b;
            color: #fca5a5;
        }

        .bet-distribution {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .distribution-item {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .distribution-item h4 {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .distribution-value {
            font-size: 24px;
            font-weight: bold;
        }

        .color-green { color: #22c55e; }
        .color-red { color: #ef4444; }
        .color-violet { color: #a855f7; }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #334155;
        }

        .results-table th {
            background: #0f172a;
            color: #94a3b8;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
        }

        .results-table tr:hover {
            background: #334155;
        }

        .results-table .recommended {
            background: #166534 !important;
        }

        .results-table .high-loss {
            color: #fca5a5;
        }

        .results-table .safe-profit {
            color: #86efac;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-warning {
            background: #f59e0b;
            color: #0f172a;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .user-bets {
            max-height: 400px;
            overflow-y: auto;
        }

        .bet-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #0f172a;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .bet-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .bet-user {
            font-weight: 600;
            color: #f8fafc;
        }

        .bet-details {
            font-size: 12px;
            color: #64748b;
        }

        .bet-amount {
            font-size: 18px;
            font-weight: bold;
            color: #60a5fa;
        }

        .login-form {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: #1e293b;
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #60a5fa;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #94a3b8;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #f8fafc;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .hidden {
            display: none !important;
        }

        .number-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .number-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0f172a;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            position: relative;
        }

        .number-cell .bet-amount-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(59, 130, 246, 0.3);
            border-radius: 0 0 8px 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #334155;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .last-updated {
            text-align: right;
            color: #64748b;
            font-size: 12px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-form">
        <h2>üîê Admin Login</h2>
        <div class="form-group">
            <label>Admin Token</label>
            <input type="password" id="adminToken" placeholder="Enter your admin JWT token">
        </div>
        <div class="form-group">
            <label>Round ID (Optional)</label>
            <input type="text" id="roundId" placeholder="Leave empty for active round">
        </div>
        <button class="btn btn-primary" onclick="connect()" style="width: 100%;">Connect to Dashboard</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
        <div class="header">
            <h1>üéÆ Admin Risk Dashboard</h1>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <span>Round: <strong id="roundPeriod">-</strong></span>
                    <span style="margin-left: 20px;">Status: <strong id="roundStatus">-</strong></span>
                </div>
                <div id="connectionStatus" class="connection-status disconnected">
                    <span class="status-dot"></span>
                    <span>Disconnected</span>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="last-updated">Last updated: <span id="lastUpdated">-</span></div>

            <!-- Summary Cards -->
            <div class="grid">
                <div class="card">
                    <h2>Total Collection</h2>
                    <div class="stat-value" id="totalCollection">‚Çπ0</div>
                    <div class="stat-label">From all bets</div>
                </div>
                <div class="card">
                    <h2>Total Bets</h2>
                    <div class="stat-value" id="totalBets">0</div>
                    <div class="stat-label">Active bets</div>
                </div>
                <div class="card">
                    <h2>Risk Level</h2>
                    <div id="riskLevel">
                        <span class="risk-indicator risk-safe">SAFE</span>
                    </div>
                    <div class="stat-label" id="riskDetails">All results profitable</div>
                </div>
                <div class="card">
                    <h2>Recommended Result</h2>
                    <div class="stat-value" id="recommendedResult" style="font-size: 24px;">-</div>
                    <div class="stat-label" id="recommendedProfit">Profit: ‚Çπ0</div>
                </div>
            </div>

            <!-- Bet Distribution -->
            <div class="grid">
                <div class="card">
                    <h2>Color Distribution</h2>
                    <div class="bet-distribution">
                        <div class="distribution-item">
                            <h4>Green</h4>
                            <div class="distribution-value color-green" id="greenAmount">‚Çπ0</div>
                        </div>
                        <div class="distribution-item">
                            <h4>Red</h4>
                            <div class="distribution-value color-red" id="redAmount">‚Çπ0</div>
                        </div>
                        <div class="distribution-item">
                            <h4>Violet</h4>
                            <div class="distribution-value color-violet" id="violetAmount">‚Çπ0</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>Size Distribution</h2>
                    <div class="bet-distribution">
                        <div class="distribution-item">
                            <h4>Big</h4>
                            <div class="distribution-value" id="bigAmount">‚Çπ0</div>
                        </div>
                        <div class="distribution-item">
                            <h4>Small</h4>
                            <div class="distribution-value" id="smallAmount">‚Çπ0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Number Distribution -->
            <div class="card" style="margin-bottom: 20px;">
                <h2>Number Distribution</h2>
                <div class="number-grid" id="numberGrid">
                    <!-- Generated by JS -->
                </div>
            </div>

            <!-- Admin Controls -->
            <div class="card" style="margin-bottom: 20px;">
                <h2>Admin Controls</h2>
                <div class="controls">
                    <button class="btn btn-primary" onclick="forceResult()">üéØ Force Result</button>
                    <button class="btn btn-primary" onclick="autoResult()">ü§ñ Auto Result</button>
                    <button class="btn btn-warning" onclick="pauseBetting()">‚è∏Ô∏è Pause Betting</button>
                    <button class="btn btn-primary" onclick="resumeBetting()">‚ñ∂Ô∏è Resume Betting</button>
                    <button class="btn btn-danger" onclick="cancelRound()">‚ùå Cancel Round</button>
                </div>
            </div>

            <!-- Results Analysis -->
            <div class="card" style="margin-bottom: 20px;">
                <h2>Results Analysis (All Possible Outcomes)</h2>
                <div style="overflow-x: auto;">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Number</th>
                                <th>Color</th>
                                <th>Size</th>
                                <th>Color Payout</th>
                                <th>Size Payout</th>
                                <th>Number Payout</th>
                                <th>Total Payout</th>
                                <th>Profit/Loss</th>
                                <th>Profit %</th>
                                <th>Risk</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- Generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- User Bets -->
            <div class="card">
                <h2>Recent Bets</h2>
                <div class="user-bets" id="userBets">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let socket = null;
        let currentRoundId = null;
        let authToken = null;

        // Format currency
        function formatCurrency(amount) {
            return '‚Çπ' + parseFloat(amount).toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Format number
        function formatNumber(num) {
            return num.toString().padStart(2, '0');
        }

        // Connect to WebSocket
        async function connect() {
            authToken = document.getElementById('adminToken').value;
            const roundIdInput = document.getElementById('roundId').value;

            if (!authToken) {
                alert('Please enter admin token');
                return;
            }

            // Show loading
            document.getElementById('loginScreen').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Connecting...</p>
                </div>
            `;

            // Connect to Socket.io
            socket = io(`${API_URL}/admin-risk`, {
                auth: { token: authToken }
            });

            socket.on('connect', () => {
                console.log('Connected to risk dashboard');
                updateConnectionStatus(true);
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');

                // Subscribe to round
                if (roundIdInput) {
                    currentRoundId = roundIdInput;
                    socket.emit('subscribe-round', currentRoundId);
                }
            });

            socket.on('connect_error', (err) => {
                console.error('Connection error:', err);
                alert('Connection failed: ' + err.message);
                location.reload();
            });

            socket.on('initial-data', (data) => {
                console.log('Initial data:', data);
                if (data.round) {
                    currentRoundId = data.round.id;
                    socket.emit('subscribe-round', currentRoundId);
                }
                updateSummary(data);
            });

            socket.on('round-data', (data) => {
                console.log('Round data:', data);
                updateDashboard(data);
            });

            socket.on('round-update', (data) => {
                console.log('Round update:', data);
                updateDashboard(data.data);
                document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
            });

            socket.on('new-bet', (data) => {
                console.log('New bet:', data);
                updateDashboard(data.updatedAnalysis);
            });

            socket.on('result-declared', (data) => {
                alert(`Result declared: ${data.result.winningNumber} (${data.result.winningColor})`);
            });

            socket.on('round-cancelled', (data) => {
                alert('Round has been cancelled');
            });

            socket.on('status-changed', (data) => {
                document.getElementById('roundStatus').textContent = data.status;
            });

            socket.on('action-success', (data) => {
                console.log('Action success:', data);
            });

            socket.on('action-error', (data) => {
                alert('Error: ' + data.message);
            });

            socket.on('disconnect', () => {
                updateConnectionStatus(false);
            });
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.innerHTML = '<span class="status-dot"></span><span>Connected</span>';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.innerHTML = '<span class="status-dot"></span><span>Disconnected</span>';
            }
        }

        function updateSummary(data) {
            if (data.round) {
                document.getElementById('roundPeriod').textContent = data.round.period;
                document.getElementById('roundStatus').textContent = data.round.status;
            }

            if (data.summary) {
                document.getElementById('totalCollection').textContent = formatCurrency(data.summary.totalAmount);
                document.getElementById('totalBets').textContent = data.summary.totalBets;
            }

            if (data.riskStatus) {
                updateRiskIndicator(data.riskStatus);
            }

            if (data.recommended) {
                document.getElementById('recommendedResult').textContent = 
                    `${data.recommended.number} (${data.recommended.color}, ${data.recommended.size})`;
                document.getElementById('recommendedProfit').textContent = 
                    `Profit: ${formatCurrency(data.recommended.profit)} (${data.recommended.profitPercent.toFixed(2)}%)`;
            }
        }

        function updateDashboard(data) {
            // Update round info
            if (data.round) {
                document.getElementById('roundPeriod').textContent = data.round.period;
                document.getElementById('roundStatus').textContent = data.round.status;
            }

            // Update bet distribution
            if (data.betDistribution) {
                const dist = data.betDistribution;
                document.getElementById('totalCollection').textContent = formatCurrency(dist.totalAmount);
                document.getElementById('totalBets').textContent = dist.totalBets;
                document.getElementById('greenAmount').textContent = formatCurrency(dist.colors.GREEN);
                document.getElementById('redAmount').textContent = formatCurrency(dist.colors.RED);
                document.getElementById('violetAmount').textContent = formatCurrency(dist.colors.VIOLET);
                document.getElementById('bigAmount').textContent = formatCurrency(dist.sizes.BIG);
                document.getElementById('smallAmount').textContent = formatCurrency(dist.sizes.SMALL);

                // Update number grid
                updateNumberGrid(dist.numbers, dist.totalAmount);
            }

            // Update risk indicators
            if (data.riskIndicators) {
                updateRiskIndicator(data.riskIndicators);
            }

            // Update recommended result
            if (data.recommendedResult) {
                const rec = data.recommendedResult.recommended;
                document.getElementById('recommendedResult').textContent = 
                    `${rec.number} (${rec.color}, ${rec.size})`;
                document.getElementById('recommendedProfit').textContent = 
                    `Profit: ${formatCurrency(rec.profit)} (${rec.profitPercent.toFixed(2)}%)`;
            }

            // Update results table
            if (data.resultAnalysis) {
                updateResultsTable(data.resultAnalysis);
            }

            // Update user bets
            if (data.userBets) {
                updateUserBets(data.userBets);
            }

            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        }

        function updateRiskIndicator(riskStatus) {
            const riskEl = document.getElementById('riskLevel');
            const riskDetails = document.getElementById('riskDetails');

            let riskClass = 'risk-safe';
            let riskText = 'SAFE';

            if (riskStatus.overallRisk === 'HIGH') {
                riskClass = 'risk-high';
                riskText = 'HIGH RISK';
            } else if (riskStatus.overallRisk === 'MEDIUM') {
                riskClass = 'risk-medium';
                riskText = 'MEDIUM RISK';
            }

            riskEl.innerHTML = `<span class="risk-indicator ${riskClass}">${riskText}</span>`;
            riskDetails.textContent = 
                `${riskStatus.safeProfitCount} safe, ${riskStatus.mediumRiskCount} medium, ${riskStatus.highLossCount} loss results`;
        }

        function updateNumberGrid(numbers, totalAmount) {
            const grid = document.getElementById('numberGrid');
            grid.innerHTML = '';

            const maxAmount = Math.max(...Object.values(numbers));

            for (let i = 0; i <= 9; i++) {
                const amount = numbers[i] || 0;
                const percentage = maxAmount > 0 ? (amount / maxAmount) * 100 : 0;
                
                const cell = document.createElement('div');
                cell.className = 'number-cell';
                cell.innerHTML = `
                    <div>${i}</div>
                    <div class="bet-amount-bar" style="height: ${percentage}%"></div>
                `;
                cell.title = `Number ${i}: ${formatCurrency(amount)}`;
                grid.appendChild(cell);
            }
        }

        function updateResultsTable(results) {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            results.forEach((result, index) => {
                const row = document.createElement('tr');
                if (index === 0) row.classList.add('recommended');
                if (result.riskLevel === 'HIGH_LOSS') row.classList.add('high-loss');
                if (result.riskLevel === 'SAFE_PROFIT') row.classList.add('safe-profit');

                const profitClass = result.profit >= 0 ? 'safe-profit' : 'high-loss';

                row.innerHTML = `
                    <td><strong>${result.number}</strong></td>
                    <td>${result.color}</td>
                    <td>${result.size}</td>
                    <td>${formatCurrency(result.colorPayout)}</td>
                    <td>${formatCurrency(result.sizePayout)}</td>
                    <td>${formatCurrency(result.numberPayout)}</td>
                    <td>${formatCurrency(result.totalPayout)}</td>
                    <td class="${profitClass}">${formatCurrency(result.profit)}</td>
                    <td class="${profitClass}">${result.profitPercent.toFixed(2)}%</td>
                    <td><span class="risk-indicator ${getRiskClass(result.riskLevel)}">${result.riskLevel.replace('_', ' ')}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function getRiskClass(riskLevel) {
            switch (riskLevel) {
                case 'SAFE_PROFIT': return 'risk-safe';
                case 'MEDIUM_RISK': return 'risk-medium';
                case 'HIGH_LOSS': return 'risk-high';
                default: return 'risk-safe';
            }
        }

        function updateUserBets(bets) {
            const container = document.getElementById('userBets');
            container.innerHTML = '';

            // Show last 20 bets
            bets.slice(0, 20).forEach(bet => {
                const item = document.createElement('div');
                item.className = 'bet-item';
                item.innerHTML = `
                    <div class="bet-info">
                        <div class="bet-user">${bet.userName || bet.userMobile}</div>
                        <div class="bet-details">${bet.betType}: ${bet.selection}</div>
                    </div>
                    <div class="bet-amount">${formatCurrency(bet.amount)}</div>
                `;
                container.appendChild(item);
            });
        }

        // Admin Actions
        function forceResult() {
            const winningOption = prompt('Enter winning option (0-9, GREEN, RED, VIOLET, BIG, SMALL):');
            if (winningOption && currentRoundId) {
                socket.emit('force-result', { gameRoundId: currentRoundId, winningOption });
            }
        }

        function autoResult() {
            if (currentRoundId && confirm('Calculate auto result for this round?')) {
                socket.emit('auto-result', { gameRoundId: currentRoundId });
            }
        }

        function pauseBetting() {
            if (currentRoundId) {
                socket.emit('pause-betting', { gameRoundId: currentRoundId });
            }
        }

        function resumeBetting() {
            if (currentRoundId) {
                socket.emit('resume-betting', { gameRoundId: currentRoundId });
            }
        }

        function cancelRound() {
            if (currentRoundId && confirm('Are you sure you want to cancel this round? All bets will be refunded.')) {
                socket.emit('cancel-round', { gameRoundId: currentRoundId });
            }
        }
    </script>
</body>
</html>
